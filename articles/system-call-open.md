---
title: "システムコールAPI"
emoji: "👏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["linux"]
published: false
---


1. 導入：一つのフラグから広がった世界
- 	Linuxプログラミングを学んでいて出会った open(O_CREAT | O_EXCL)。
- 	最初は「ファイルを安全に作成するための便利なフラグ」くらいに思っていた。
- 	しかしその背後にはプロセスの並行実行やアトミック操作という奥深い世界が広がっていた。
- 	本記事では、このフラグを入り口に、システムコール、アトミック、そしてタイムスライスとレースコンディションについて考えていく。

⸻

2. open(O_CREAT | O_EXCL) の役割と危険なパターン

2.1 フラグの意味
- 	O_CREAT：ファイルがなければ新規作成
- 	O_EXCL：ファイルがすでに存在すればエラー（EEXIST）
- 	この組み合わせにより、「存在確認」と「新規作成」を一度に実行できる。

2.2 悪い例：access() → open()
- 	存在確認と作成を分けて書くと、間に他のプロセスが割り込む可能性がある。
- 	これはTOCTOU（Time Of Check To Time Of Use）問題と呼ばれる。

if (access("file.txt", F_OK) == -1) {
    open("file.txt", O_WRONLY | O_CREAT); // ← ここで割り込みが入るかも
}


⸻

3. レースコンディションはなぜ起きるのか：タイムスライス登場

ここでタイムスライスという概念が登場する。

3.1 タイムスライスとは
- 	OSは複数プロセスを同時に動いているように見せるため、CPU時間を細かく分割して使わせる。
- 	1つのプロセスがCPUを占有できる最大時間がタイムスライス。
  -	例: 10msで切り替え

3.2 割り込みの瞬間に起きること
- 	プロセスAが1回目のopen()で「ファイルが存在しない」と判断
- 	しかしタイムスライスが切れて、CPUがプロセスBに切り替わる
- 	プロセスBが同じファイルを作成
- 	再びプロセスAが実行され、2回目のopen()を実行
- 	→ Aは「自分が作成した」と誤認してしまう

時間 →
┌──────────────┬──────────────┬──────────────┐
|  プロセスA        |  プロセスB        |  プロセスA再開   |
|  open(存在確認)   |  open(作成)      |  open(2回目)     |
└──────────────┴──────────────┴──────────────┘
         ↑タイムスライス終了 → CPUがAからBに切り替わる

これが典型的なレースコンディション発生シナリオ。

⸻

4. open(O_CREAT | O_EXCL) で解決できる理由
- 	open(O_CREAT | O_EXCL) は存在確認＋新規作成を1回のシステムコールでアトミックに実行する。
- 	OSが内部でロックを取り、処理が割り込まれない。
- 	これによりTOCTOU問題を解消できる。

⸻

5. アトミック操作とは何か
- 	アトミック＝「分割されず、一連の操作が他プロセスから見て一瞬で終わる」こと。
- 	ここで重要なのは、「システムコールだから常にアトミック」というわけではないという点。
- 	例：
  -	open(O_CREAT | O_EXCL) → アトミック保証あり（仕様で明記）
  -	read() → アトミック保証なし
  -	write() → パイプに4,096バイト以下ならアトミック

→ アトミック性はシステムコールごとに異なる。

⸻

6. 実験：タイムスライスを使ったレースを再現
- 	2つのプロセスを並列に実行し、意図的にTOCTOUを発生させる。
- 	片方がファイル作成に成功、もう片方が誤って上書き。
- 	次に O_CREAT | O_EXCL を使うと片方はEEXISTで失敗することを確認。

⸻

7. 公式ドキュメントで裏付け
- 	man 2 open
This is guaranteed to be atomic.
- 	POSIX仕様
without the possibility of a race condition
- 	実装レベルでは、カーネルがinodeロックを使ってアトミック性を保証。

⸻

8. 応用例
- 	ロックファイル：排他制御をシンプルに実現
- 	一時ファイル作成：mkstemp() や O_TMPFILE
- 	安全なファイル更新：一時ファイル→fsync()→rename()（renameも多くのFSでアトミック）

⸻

9. まとめ：タイムスライスとアトミックを意識する
- 	タイムスライスによるCPU切り替えが、並列実行環境では必ず起きる。
- 	その切り替えがレースコンディションの根本原因。
- 	open(O_CREAT | O_EXCL) は、こうした割り込みの隙間をなくす「アトミックな武器」。
- 	システムコールの設計意図を理解することで、より堅牢なプログラムが書ける。

⸻

本記事で伝えたいこと
- 	open(O_CREAT | O_EXCL) というフラグをきっかけに、
  -	プロセススケジューリング（タイムスライス）
  -	レースコンディション
  -	アトミック操作
を体系的に理解できる。
- 	Linuxプログラミングは、APIの使い方を覚えるだけではなく、OS内部の仕組みと連動して理解することが重要。

⸻
